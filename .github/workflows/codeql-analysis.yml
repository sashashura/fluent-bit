# For most projects, this workflow file will not need changing; you simply need
# to commit it to your repository.
#
# You may wish to alter this file to override the set of languages analyzed,
# or to provide custom queries or build logic.
#
# ******** NOTE ********
# We have attempted to detect the languages in your repository. Please check
# the `language` matrix defined below to confirm you have the correct set of
# supported CodeQL languages.
#
name: "CodeQL"

on:
  workflow_dispatch:

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      # actions: read
      # contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'cpp']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    # Initializes the CodeQL tools for scanning.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: ${{ matrix.language }}
        # If you wish to specify custom queries, you can do so here or in a config file.
        # By default, queries listed here will override any specified in a config file.
        # Prefix the list here with "+" to use these queries and those in the config file.
        
        # Details on CodeQL's query packs refer to : https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#using-queries-in-ql-packs
        # queries: security-extended,security-and-quality

    # ‚ÑπÔ∏è Command-line programs to run using the OS shell.
    # üìö See https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepsrun

    #   If the Autobuild fails above, remove it and uncomment the following three lines. 
    #   modify them (or add more) to build your code if your project, please refer to the EXAMPLE below for guidance.

    - name: Build Fluent Bit packages
      run: |
        cd build
        # Plugins enabled/disabled

        INPUT_PLUGINS="-DFLB_IN_COLLECTD=OFF \
          -DFLB_IN_CPU=OFF     \
          -DFLB_IN_DISK=OFF    \
          -DFLB_IN_DOCKER=OFF  \
          -DFLB_IN_EXEC=OFF    \
          -DFLB_IN_FORWARD=OFF \
          -DFLB_IN_HEAD=OFF    \
          -DFLB_IN_HEALTH=OFF  \
          -DFLB_IN_KMSG=OFF    \
          -DFLB_IN_MEM=OFF     \
          -DFLB_IN_MQTT=OFF    \
          -DFLB_IN_NETIF=OFF   \
          -DFLB_IN_PROC=OFF    \
          -DFLB_IN_RANDOM=OFF  \
          -DFLB_IN_SERIAL=OFF  \
          -DFLB_IN_STDIN=OFF   \
          -DFLB_IN_SYSLOG=OFF  \
          -DFLB_IN_SYSTEMD=OFF \
          -DFLB_IN_TAIL=OFF    \
          -DFLB_IN_TCP=OFF     \
          -DFLB_IN_THERMAL=OFF \
          -DFLB_IN_WINLOG=OFF"

        OUTPUT_PLUGINS="-DFLB_OUT_AZURE=OFF  \
          -DFLB_OUT_BIGQUERY=OFF      \
          -DFLB_OUT_COUNTER=OFF       \
          -DFLB_OUT_DATADOG=OFF       \
          -DFLB_OUT_ES=OFF            \
          -DFLB_OUT_FILE=OFF          \
          -DFLB_OUT_FLOWCOUNTER=OFF   \
          -DFLB_OUT_FORWARD=OFF       \
          -DFLB_OUT_GELF=OFF          \
          -DFLB_OUT_HTTP=ON           \
          -DFLB_OUT_INFLUXDB=OFF      \
          -DFLB_OUT_KAFKA=OFF         \
          -DFLB_OUT_KAFKA_REST=OFF    \
          -DFLB_OUT_LOKI=OFF          \
          -DFLB_OUT_NATS=OFF          \
          -DFLB_OUT_NRLOGS=OFF        \
          -DFLB_OUT_NULL=OFF          \
          -DFLB_OUT_PGSQL=OFF         \
          -DFLB_OUT_PLOT=OFF          \
          -DFLB_OUT_SLACK=OFF         \
          -DFLB_OUT_SPLUNK=OFF        \
          -DFLB_OUT_STACKDRIVER=OFF   \
          -DFLB_OUT_STDOUT=ON         \
          -DFLB_OUT_SYSLOG=OFF        \
          -DFLB_OUT_TCP=OFF"

        MISC_PLUGINS="-DFLB_LUAJIT=OFF \
          -DFLB_STREAM_PROCESSOR=OFF"

        FILTER_PLUGINS="-DFLB_FILTER_ALTER_SIZE=ON  \
          -DFLB_FILTER_AWS=ON              \
          -DFLB_FILTER_GREP=ON             \
          -DFLB_FILTER_KUBERNETES=ON       \
          -DFLB_FILTER_MODIFY=ON           \
          -DFLB_FILTER_NEST=ON             \
          -DFLB_FILTER_PARSER=ON           \
          -DFLB_FILTER_RECORD_MODIFIER=ON  \
          -DFLB_FILTER_REWRITE_TAG=ON      \
          -DFLB_FILTER_THROTTLE=ON"

        EXTRA_FLAGS="-DFLB_BINARY=OFF \
          -DFLB_EXAMPLES=OFF \
          -DFLB_METRICS=ON   \
          -DFLB_DEBUG=ON     \
          -DMBEDTLS_FATAL_WARNINGS=OFF \
          -DFLB_CONFIG_YAML=OFF"

        cmake -DFLB_TESTS_INTERNAL=ON \
              -DFLB_TESTS_INTERNAL_FUZZ=ON \
              -DFLB_TESTS_OSSFUZZ=ON \
              ${EXTRA_FLAGS} \
              ${INPUT_PLUGINS} \
              ${FILTER_PLUGINS} \
              ${MISC_PLUGINS} \
              ${OUTPUT_PLUGINS} \
              ..

        make

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
